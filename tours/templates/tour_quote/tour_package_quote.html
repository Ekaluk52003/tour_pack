{% extends "base.html" %}

{% block extra_head %}
<script>
    // Define guide services data globally
    window.guideServicesData = JSON.parse('{{ guide_services_json|escapejs }}');
</script>
<style>
    .drag-ghost {
      opacity: 0.5;
      background: #c8e6c9;
      border: 2px dashed #4caf50;
    }
    .drop-zone-active {
      border: 2px dashed #2196f3;
      background-color: #e3f2fd;
    }
    .service-item {
      transition: all 0.2s ease-in-out;
    }
    .service-item:hover {
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .drag-ghost {
      opacity: 0.5;
      background: #c8e6c9;
      border: 2px dashed #4caf50;
    }
    .drop-zone-active {
      border: 2px dashed #2196f3;
      background-color: #e3f2fd;
    }
  </style>
{% endblock %}

{% block content %}
<div x-data="tourPackage()" x-init="guideServices = window.guideServicesData" class="max-w-4xl mx-auto bg-white p-8 rounded shadow-lg">
    <h1 class="text-3xl font-bold mb-6">Create Tour Package Quote</h1>

    <div class="mb-4">
        <label for="package-name" class="block text-sm font-medium text-gray-700">Package Name</label>
        <input type="text" id="package-name" x-model="name"  class="w-full border rounded px-3 py-2">
        <p class="text-red-500 text-sm mt-1" x-show="errors.name" x-text="errors.name"></p>
    </div>

    <div class="mb-4">
        <label for="customer-name" class="block text-sm font-medium text-gray-700">Customer Name</label>
        <input type="text" id="customer-name" x-model="customerName" class="w-full border rounded px-3 py-2">
        <p class="text-red-500 text-sm mt-1" x-show="errors.customerName" x-text="errors.customerName"></p>
    </div>
    <div class="mb-4">
      <label for="remark" class="block text-sm font-medium text-gray-700">Remark</label>
      <textarea id="remark" x-model="remark" class="w-full border rounded px-3 py-2"></textarea>
  </div>

  <div class="mb-4">
    <label for="tourPackType" class="block text-sm font-medium text-gray-700">Tour Package Type</label>
    <select id="tourPackType" x-model="tourPackType" @change="updateServicesForPackageType()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
        <option value="">Select Tour Package Type</option>
        {% for pack_type in tour_pack_types %}
            <option value="{{ pack_type.id }}">{{ pack_type.name }}</option>
        {% endfor %}
    </select>
</div>
  <div class="mb-4" x-show="errors.days">
    <p class="text-red-500 text-sm" x-text="errors.days"></p>
</div>

<template x-for="(day, dayIndex) in days" :key="dayIndex">
    <div class="mb-4">
        <!-- ... (existing day fields) ... -->
        <p class="text-red-500 text-sm mt-1" x-show="errors[`day${dayIndex + 1}_date`]" x-text="errors[`day${dayIndex + 1}_date`]"></p>
        <p class="text-red-500 text-sm mt-1" x-show="errors[`day${dayIndex + 1}_city`]" x-text="errors[`day${dayIndex + 1}_city`]"></p>
        <p class="text-red-500 text-sm mt-1" x-show="errors[`day${dayIndex + 1}_hotel`]" x-text="errors[`day${dayIndex + 1}_hotel`]"></p>
    </div>
</template>

<!-- Predefined Tour Quote Selection -->
<select x-model="selectedPredefinedQuote">
  <option value="">Select a predefined quote</option>
  {% for quote in predefined_quotes %}
      <option value="{{ quote.id }}">{{ quote.name }}</option>
  {% endfor %}
</select>
<button @click="applyPredefinedQuote()">Apply Predefined Quote</button>

    <div class="space-y-2">
        <template x-for="(day, dayIndex) in days" :key="dayIndex">
          <div class="mb-4"
          draggable="true"
          @dragstart="dragStart($event, dayIndex)"
          @dragover.prevent
          @dragenter.prevent
          @drop="drop($event, dayIndex)">
          <div class="border rounded-lg p-4 mb-2 cursor-move bg-white hover:bg-gray-50"
          :class="{'border-blue-500': draggingIndex === dayIndex}">
              <div class="flex justify-between items-center mb-2">
                <h2 class="text-xl font-semibold" x-text="`Day ${dayIndex + 1}`"></h2>
                <div class="flex items-center">
                  <span class="mr-2 text-gray-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                  </span>
                  <button @click="removeDay(dayIndex)" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded transition duration-150 ease-in-out">Remove Day</button>
                </div>
              </div>

              <div class="mb-2">
                <label class="block mb-2">Date</label>
                <input type="date" x-model="day.date" class="w-full border rounded px-3 py-2">
              </div>

              <div class="mb-2">
                <label class="block mb-2">City</label>
                <select x-model="day.city" @change="updateCityServices(dayIndex)" class="w-full border rounded px-3 py-2">
                  <option value="">Select City</option>
                  {% for city in cities %}
                    <option value="{{ city.id }}">{{ city.name }}</option>
                  {% endfor %}
                </select>
            </div>

            <div class="mb-2">
              <label :for="`day-${dayIndex}-hotel`" class="block">Hotel</label>
              <select :id="`day-${dayIndex}-hotel`" x-model.number="day.hotel" class="w-full p-2 border rounded">
                  <option value="">Select Hotel</option>
                  <template x-for="hotel in day.cityServices.hotels" :key="hotel.id">
                      <option :value="hotel.id" x-text="hotel.name" :selected="hotel.id === day.hotel"></option>
                  </template>
              </select>
          </div>


            <!-- Services -->
            <div class="mb-4">
              <h3 class="text-lg font-semibold mb-2">Services</h3>
              <div class="space-y-2">
                <template x-for="(service, serviceIndex) in day.services" :key="serviceIndex">
                  <div class="flex items-center mb-2 bg-white p-2 rounded border service-item">

            <select x-model="service.type" @change="service.name = ''" class="mr-2 p-2 border rounded">
              <option value="">Select Service Type</option>
              <option value="transfer">Transfer</option>
              <option value="tour">Tour</option>
            </select>
            <select x-model="service.name" @change="updateService(dayIndex, serviceIndex)" class="mr-2 p-2 border rounded">
              <option value="">Select Service</option>
              <template x-for="option in getServiceNames(dayIndex, service.type)" :key="option.id">
                <option :value="String(option.id)" x-text="`${option.name} (${option.price} USD)`" :selected="service.name == option.id"></option>
              </template>
            </select>

            <!-- <span class="ml-2" x-text="`Current: ${service.price} USD`"></span> -->
            <button @click="removeService(dayIndex, serviceIndex)" class="ml-2 text-red-600">Remove</button>



                  </div>
                </template>
              </div>

              <button @click="addService(dayIndex)" class="bg-blue-500 text-white px-3 py-2 rounded">Add Service</button>
            </div>
            <!-- Guide Services -->
            <div class="mb-4">
              <h3 class="text-lg font-semibold mb-2 mt-4">Guide Services</h3>
              <template x-for="(guideService, guideIndex) in day.guideServices" :key="guideIndex">
                <div class="flex items-center mb-2">
                  <select x-model="guideService.name" @change="updateGuideService(dayIndex, guideIndex)" class="w-3/4 border rounded px-3 py-2 mr-2">
                    <option value="">Select Guide Service</option>
                    <template x-for="option in guideServices" :key="option.id">
                      <option :value="String(option.id)" x-text="`${option.name} (${option.price} USD)`" :selected="guideService.name == option.id"></option>
                    </template>
                  </select>

                  <!-- <span class="ml-2" x-text="`Current: ${guideService.price.toFixed(2)} USD`"></span> -->

                  <button @click="removeGuideService(dayIndex, guideIndex)"  class="ml-2 text-red-600">Remove</button>
                </div>
              </template>
              <button @click="addGuideService(dayIndex)" class="bg-blue-500 text-white px-3 py-2 rounded">Add Guide Service</button>
            </div>


        </div>
    </template>

    <button @click="addDay()" class="mb-4">Add Day</button>

        <!-- Add Day button at the end -->
        <button @click="insertDayBelow(days.length - 1)"
                class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded flex items-center justify-center">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Add Day
        </button>
    </div>

    <div class="my-4">
      <h3 class="text-lg font-semibold">Service Grand Total:
          <span x-text="calculateGrandTotal().serviceGrandTotal + ' USD'"></span>
      </h3>
  </div>



    <div class="mb-4">
      <h2 class="text-xl font-semibold mb-2">Hotel Costs</h2>
      <div class="overflow-x-auto">
        <table class="w-full table-auto">
          <thead>
            <tr class="bg-gray-200">
              <th class="px-2 text-left">Name</th>
              <th class="px-2 text-left">Type</th>
              <th class="px-2 text-left">Nights</th>
              <th class="px-2 text-left">Rooms</th>
              <th class="px-2 text-left">Price per Night</th>
              <th class="px-2 text-left">Total</th>
              <th class="px-2 text-left">Actions</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="(hotelCost, index) in hotelCosts" :key="index">
              <tr>
                <td class="border px-2">
                  <input type="text" x-model="hotelCost.name" class="w-full p-1 border rounded">
                </td>
                <td class="border px-2">
                  <input type="text" x-model="hotelCost.type" class="w-full p-1 border rounded">
                </td>
                <td class="border px-2">
                  <input type="number" x-model.number="hotelCost.nights" min="1" class="w-full p-1 border rounded">
                </td>
                <td class="border px-2">
                  <input type="number" x-model.number="hotelCost.room" min="1" class="w-full p-1 border rounded">
                </td>
                <td class="border px-2">
                  <input type="number" x-model.number="hotelCost.price" min="0" step="0.01" class="w-full p-1 border rounded">
                </td>
                <td class="border px-2" x-text="(hotelCost.room * hotelCost.nights * hotelCost.price).toFixed(2) + ' USD'"></td>
                <td class="border px-4 py-2">
                  <button @click="removeHotelCost(index)" class="bg-red-500 text-white px-2 py-1 rounded">Delete</button>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
      <button @click="addHotelCost" class="mt-2 bg-blue-500 text-white px-3 py-2 rounded">Add Hotel Cost</button>
      <div class="mt-2 text-right">
        <strong>Total Hotel Cost: </strong>
        <span x-text="calculateHotelCostTotal() + ' USD'"></span>
      </div>
    </div>
    <!-- Discounts Section -->
    <div class="mb-4">
      <h2 class="text-xl font-semibold mb-2">Discounts</h2>
      <div class="overflow-x-auto">
        <table class="w-full table-auto">
          <thead>
            <tr class="bg-gray-200">
              <th class="px-2 text-left">Item</th>
              <th class="px-2 text-left">Discount Amount</th>
              <th class="px-2 text-left">Actions</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="(discount, index) in discounts" :key="index">
              <tr>
                <td class="border px-2">
                  <input type="text" x-model="discount.item" class="w-full p-1 border rounded">
                </td>
                <td class="border px-2">
                  <input type="number" x-model.number="discount.amount" min="0" step="0.01" class="w-full p-1 border rounded">
                </td>
                <td class="border px-4 py-2">
                  <button @click="removeDiscount(index)" class="bg-red-500 text-white px-2 py-1 rounded">Delete</button>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
      <button @click="addDiscount" class="mt-2 bg-blue-500 text-white px-3 py-2 rounded">Add Discount</button>
      <div class="mt-2 text-right">
        <strong>Total Discounts: </strong>
        <span x-text="calculateTotalDiscounts() + ' USD'"></span>
      </div>
    </div>

<!-- Grand Total Section -->
<div class="mb-4 mt-8">
  <h3 class="text-lg font-semibold">Grand Total Cost:
    <span x-text="(parseFloat(calculateGrandTotal().grandTotal) - calculateTotalDiscounts()).toFixed(2) + ' USD'"></span>
  </h3>
</div>
    <button @click="saveTourPackage" class="mt-4 bg-indigo-500 text-white px-4 py-2 rounded">Create Quote</button>
</div>
{% endblock %}